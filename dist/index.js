#!/usr/bin/env node
import x from'process';import {json}from'stream/consumers';import Y from'tty';import {exec,execSync}from'child_process';import {promisify}from'util';import w,{existsSync,readFileSync,createReadStream}from'fs';import _,{join,posix,dirname}from'path';import {get}from'https';import {URL}from'url';import ye,{homedir}from'os';import {createHash}from'crypto';import {setTimeout}from'timers/promises';import {readdir,stat,readFile}from'fs/promises';import {createInterface}from'readline';function L(r,e){if(e&&(r.toLowerCase()==="transparent"||r.toLowerCase()==="none"))return "\x1B[49m";let t=parseInt(r.slice(1,3),16),n=parseInt(r.slice(3,5),16),s=parseInt(r.slice(5,7),16);return `\x1B[${e?"48":"38"};2;${t};${n};${s}m`}function J(r,e=false){if(!r||r==="")return "";let t=r.match(/48;2;(\d+);(\d+);(\d+)/);if(t)return `\x1B[38;2;${t[1]};${t[2]};${t[3]}m`;if(e)return "\x1B[37m";if(r.includes("\x1B[")&&r.includes("m")){let n=r.match(/\[(\d+)m/);if(n&&n[1]){let s=parseInt(n[1],10);if(s>=40&&s<=47)return `\x1B[${s-10}m`;if(s>=100&&s<=107)return `\x1B[${s-10}m`}}return r.replace("48","38")}function z(){let{env:r}=x,e=true;r.NO_COLOR&&r.NO_COLOR!==""&&(e=false);let t=r.FORCE_COLOR;if(t&&t!=="")return t==="false"||t==="0"?"none":t==="true"||t==="1"?"ansi":t==="2"?"ansi256":t==="3"?"truecolor":"ansi";if(!e||r.TERM==="dumb")return "none";if(r.CI)return ["GITHUB_ACTIONS","GITEA_ACTIONS","CIRCLECI"].some(s=>s in r)?"truecolor":"ansi";if(r.COLORTERM==="truecolor"||["xterm-kitty","xterm-ghostty","wezterm","alacritty","foot","contour"].includes(r.TERM||""))return "truecolor";if(r.TERM_PROGRAM)switch(r.TERM_PROGRAM){case "iTerm.app":return "truecolor";case "Apple_Terminal":return "ansi256";case "vscode":return "truecolor";case "Tabby":return "truecolor"}if(/-256(color)?$/i.test(r.TERM||""))return "ansi256";if(/-truecolor$/i.test(r.TERM||""))return "truecolor";if(/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(r.TERM||"")||r.COLORTERM)return "ansi";if(Y?.WriteStream?.prototype?.hasColors)try{if(!Y.WriteStream.prototype.hasColors())return "none";let o=Y.WriteStream.prototype.hasColors(256);return Y.WriteStream.prototype.hasColors(16777216)?"truecolor":o?"ansi256":"ansi"}catch{}return "ansi"}function U(r,e){if(e&&(r.toLowerCase()==="transparent"||r.toLowerCase()==="none"))return "\x1B[49m";let t=parseInt(r.slice(1,3),16),n=parseInt(r.slice(3,5),16),s=parseInt(r.slice(5,7),16),i=((c,a,g)=>c===a&&a===g?c<8?16:c>248?231:Math.round((c-8)/247*24)+232:16+36*Math.round(c/255*5)+6*Math.round(a/255*5)+Math.round(g/255*5))(t,n,s);return `\x1B[${e?"48":"38"};5;${i}m`}function I(r,e){if(e&&(r.toLowerCase()==="transparent"||r.toLowerCase()==="none"))return "\x1B[49m";if(e)return "";let t=parseInt(r.slice(1,3),16),n=parseInt(r.slice(3,5),16),s=parseInt(r.slice(5,7),16);return n>t&&n>s&&n>120?"\x1B[32m":t>n&&t>s&&t>120?"\x1B[31m":s>t&&s>n&&s>120?"\x1B[34m":(t+n+s)/3>150?"\x1B[37m":"\x1B[90m"}var we={directory:{bg:"#8b4513",fg:"#ffffff"},git:{bg:"#404040",fg:"#ffffff"},model:{bg:"#2d2d2d",fg:"#ffffff"},session:{bg:"#202020",fg:"#00ffff"},block:{bg:"#2a2a2a",fg:"#87ceeb"},today:{bg:"#1a1a1a",fg:"#98fb98"},tmux:{bg:"#2f4f2f",fg:"#90ee90"},context:{bg:"#4a5568",fg:"#cbd5e0"},contextLow:{bg:"#2d5a2d",fg:"#98fb98"},contextMed:{bg:"#5a5a2d",fg:"#ffff00"},contextHigh:{bg:"#5a2d2d",fg:"#ff6b6b"},metrics:{bg:"#374151",fg:"#d1d5db"},version:{bg:"#3a3a4a",fg:"#b8b8d0"}},xe={directory:{bg:"#af5f00",fg:"#ffffff"},git:{bg:"#444444",fg:"#ffffff"},model:{bg:"#3a3a3a",fg:"#ffffff"},session:{bg:"#262626",fg:"#00ffff"},block:{bg:"#303030",fg:"#87ceeb"},today:{bg:"#1c1c1c",fg:"#87ff87"},tmux:{bg:"#444444",fg:"#87ff87"},context:{bg:"#585858",fg:"#d0d0d0"},contextLow:{bg:"#005f00",fg:"#87ff87"},contextMed:{bg:"#5f5f00",fg:"#ffff00"},contextHigh:{bg:"#5f0000",fg:"#ff5f5f"},metrics:{bg:"#4e4e4e",fg:"#d0d0d0"},version:{bg:"#444444",fg:"#d7afff"}},ke={directory:{bg:"#d75f00",fg:"#ffffff"},git:{bg:"#585858",fg:"#ffffff"},model:{bg:"#444444",fg:"#ffffff"},session:{bg:"#303030",fg:"#00ffff"},block:{bg:"#3a3a3a",fg:"#5fafff"},today:{bg:"#262626",fg:"#00ff00"},tmux:{bg:"#585858",fg:"#00ff00"},context:{bg:"#808080",fg:"#ffffff"},contextLow:{bg:"#008700",fg:"#ffffff"},contextMed:{bg:"#878700",fg:"#000000"},contextHigh:{bg:"#870000",fg:"#ffffff"},metrics:{bg:"#666666",fg:"#ffffff"},version:{bg:"#585858",fg:"#af87ff"}};var Te={directory:{bg:"#ff6b47",fg:"#ffffff"},git:{bg:"#4fb3d9",fg:"#ffffff"},model:{bg:"#87ceeb",fg:"#000000"},session:{bg:"#da70d6",fg:"#ffffff"},block:{bg:"#6366f1",fg:"#ffffff"},today:{bg:"#10b981",fg:"#ffffff"},tmux:{bg:"#32cd32",fg:"#ffffff"},context:{bg:"#718096",fg:"#ffffff"},contextLow:{bg:"#10b981",fg:"#ffffff"},contextMed:{bg:"#f59e0b",fg:"#ffffff"},contextHigh:{bg:"#ef4444",fg:"#ffffff"},metrics:{bg:"#6b7280",fg:"#ffffff"},version:{bg:"#8b7dd8",fg:"#ffffff"}},Se={directory:{bg:"#ff5f5f",fg:"#ffffff"},git:{bg:"#5fafff",fg:"#ffffff"},model:{bg:"#87d7ff",fg:"#000000"},session:{bg:"#ff5fff",fg:"#ffffff"},block:{bg:"#5f5fff",fg:"#ffffff"},today:{bg:"#00d787",fg:"#ffffff"},tmux:{bg:"#00ff5f",fg:"#ffffff"},context:{bg:"#808080",fg:"#ffffff"},contextLow:{bg:"#00af5f",fg:"#ffffff"},contextMed:{bg:"#d7af00",fg:"#000000"},contextHigh:{bg:"#ff5f5f",fg:"#ffffff"},metrics:{bg:"#767676",fg:"#ffffff"},version:{bg:"#af87ff",fg:"#ffffff"}},ve={directory:{bg:"#ff5f5f",fg:"#ffffff"},git:{bg:"#5fafff",fg:"#ffffff"},model:{bg:"#87d7ff",fg:"#000000"},session:{bg:"#ff5fff",fg:"#ffffff"},block:{bg:"#5f5fff",fg:"#ffffff"},today:{bg:"#00d787",fg:"#ffffff"},tmux:{bg:"#00ff5f",fg:"#ffffff"},context:{bg:"#808080",fg:"#ffffff"},contextLow:{bg:"#00af00",fg:"#ffffff"},contextMed:{bg:"#d7af00",fg:"#000000"},contextHigh:{bg:"#ff0000",fg:"#ffffff"},metrics:{bg:"#767676",fg:"#ffffff"},version:{bg:"#af87ff",fg:"#ffffff"}};var Pe={directory:{bg:"#434c5e",fg:"#d8dee9"},git:{bg:"#3b4252",fg:"#a3be8c"},model:{bg:"#4c566a",fg:"#81a1c1"},session:{bg:"#2e3440",fg:"#88c0d0"},block:{bg:"#3b4252",fg:"#81a1c1"},today:{bg:"#2e3440",fg:"#8fbcbb"},tmux:{bg:"#2e3440",fg:"#8fbcbb"},context:{bg:"#5e81ac",fg:"#eceff4"},contextLow:{bg:"#a3be8c",fg:"#2e3440"},contextMed:{bg:"#ebcb8b",fg:"#2e3440"},contextHigh:{bg:"#bf616a",fg:"#eceff4"},metrics:{bg:"#b48ead",fg:"#2e3440"},version:{bg:"#434c5e",fg:"#88c0d0"}},Ee={directory:{bg:"#5f87af",fg:"#e4e4e4"},git:{bg:"#4e4e4e",fg:"#87d787"},model:{bg:"#6c6c6c",fg:"#87afd7"},session:{bg:"#3a3a3a",fg:"#5fafaf"},block:{bg:"#4e4e4e",fg:"#87afd7"},today:{bg:"#3a3a3a",fg:"#5fd7d7"},tmux:{bg:"#3a3a3a",fg:"#5fd7d7"},context:{bg:"#5f87d7",fg:"#ffffff"},contextLow:{bg:"#87af87",fg:"#3a3a3a"},contextMed:{bg:"#d7d787",fg:"#3a3a3a"},contextHigh:{bg:"#d75f5f",fg:"#ffffff"},metrics:{bg:"#d787af",fg:"#3a3a3a"},version:{bg:"#5f87af",fg:"#5fafaf"}},$e={directory:{bg:"#0087af",fg:"#ffffff"},git:{bg:"#585858",fg:"#87d700"},model:{bg:"#808080",fg:"#87afff"},session:{bg:"#444444",fg:"#00d7d7"},block:{bg:"#585858",fg:"#87afff"},today:{bg:"#444444",fg:"#00ffff"},tmux:{bg:"#444444",fg:"#00ffff"},context:{bg:"#0087ff",fg:"#ffffff"},contextLow:{bg:"#00af00",fg:"#ffffff"},contextMed:{bg:"#d7d700",fg:"#000000"},contextHigh:{bg:"#d70000",fg:"#ffffff"},metrics:{bg:"#ff87d7",fg:"#444444"},version:{bg:"#0087af",fg:"#00d7d7"}};var Re={directory:{bg:"#2f334d",fg:"#82aaff"},git:{bg:"#1e2030",fg:"#c3e88d"},model:{bg:"#191b29",fg:"#fca7ea"},session:{bg:"#222436",fg:"#86e1fc"},block:{bg:"#2d3748",fg:"#7aa2f7"},today:{bg:"#1a202c",fg:"#4fd6be"},tmux:{bg:"#191b29",fg:"#4fd6be"},context:{bg:"#414868",fg:"#c0caf5"},contextLow:{bg:"#9ece6a",fg:"#1a1b26"},contextMed:{bg:"#e0af68",fg:"#1a1b26"},contextHigh:{bg:"#f7768e",fg:"#1a1b26"},metrics:{bg:"#3d59a1",fg:"#c0caf5"},version:{bg:"#292e42",fg:"#bb9af7"}},Be={directory:{bg:"#444478",fg:"#87afff"},git:{bg:"#262640",fg:"#afff87"},model:{bg:"#1c1c30",fg:"#ff87ff"},session:{bg:"#3a3a50",fg:"#5fd7ff"},block:{bg:"#4e4e68",fg:"#5f87ff"},today:{bg:"#262640",fg:"#00d7af"},tmux:{bg:"#1c1c30",fg:"#00d7af"},context:{bg:"#5f5f87",fg:"#d7d7ff"},contextLow:{bg:"#87af5f",fg:"#1c1c1c"},contextMed:{bg:"#d7af5f",fg:"#1c1c1c"},contextHigh:{bg:"#ff5f87",fg:"#1c1c1c"},metrics:{bg:"#5f5faf",fg:"#d7d7ff"},version:{bg:"#444460",fg:"#d787ff"}},Ae={directory:{bg:"#5f5faf",fg:"#87afff"},git:{bg:"#303050",fg:"#87ff87"},model:{bg:"#262640",fg:"#ff87ff"},session:{bg:"#444470",fg:"#00d7ff"},block:{bg:"#666680",fg:"#5f87ff"},today:{bg:"#303050",fg:"#00d787"},tmux:{bg:"#262640",fg:"#00d787"},context:{bg:"#808080",fg:"#ffffff"},contextLow:{bg:"#00af00",fg:"#000000"},contextMed:{bg:"#d7af00",fg:"#000000"},contextHigh:{bg:"#ff5f5f",fg:"#000000"},metrics:{bg:"#8787d7",fg:"#ffffff"},version:{bg:"#585870",fg:"#d787ff"}};var De={directory:{bg:"#26233a",fg:"#c4a7e7"},git:{bg:"#1f1d2e",fg:"#9ccfd8"},model:{bg:"#191724",fg:"#ebbcba"},session:{bg:"#26233a",fg:"#f6c177"},block:{bg:"#2a273f",fg:"#eb6f92"},today:{bg:"#232136",fg:"#9ccfd8"},tmux:{bg:"#26233a",fg:"#908caa"},context:{bg:"#393552",fg:"#e0def4"},contextLow:{bg:"#9ccfd8",fg:"#191724"},contextMed:{bg:"#f6c177",fg:"#191724"},contextHigh:{bg:"#eb6f92",fg:"#191724"},metrics:{bg:"#524f67",fg:"#e0def4"},version:{bg:"#2a273f",fg:"#c4a7e7"}},Me={directory:{bg:"#444444",fg:"#d787d7"},git:{bg:"#262626",fg:"#87d7d7"},model:{bg:"#1c1c1c",fg:"#ffaf87"},session:{bg:"#444444",fg:"#d7af5f"},block:{bg:"#4e4e4e",fg:"#ff5f87"},today:{bg:"#3a3a3a",fg:"#87d7d7"},tmux:{bg:"#444444",fg:"#9e9e9e"},context:{bg:"#585858",fg:"#e4e4e4"},contextLow:{bg:"#5fd7d7",fg:"#1c1c1c"},contextMed:{bg:"#d7af5f",fg:"#1c1c1c"},contextHigh:{bg:"#ff5f87",fg:"#1c1c1c"},metrics:{bg:"#767676",fg:"#e4e4e4"},version:{bg:"#4e4e4e",fg:"#d787d7"}},Fe={directory:{bg:"#585858",fg:"#ff87ff"},git:{bg:"#303030",fg:"#00d7d7"},model:{bg:"#262626",fg:"#ffaf87"},session:{bg:"#585858",fg:"#d7af00"},block:{bg:"#666666",fg:"#ff5f87"},today:{bg:"#444444",fg:"#00d7d7"},tmux:{bg:"#585858",fg:"#bcbcbc"},context:{bg:"#808080",fg:"#ffffff"},contextLow:{bg:"#00d7d7",fg:"#000000"},contextMed:{bg:"#d7af00",fg:"#000000"},contextHigh:{bg:"#ff5f87",fg:"#000000"},metrics:{bg:"#a8a8a8",fg:"#000000"},version:{bg:"#666666",fg:"#ff87ff"}};var Le={directory:{bg:"#504945",fg:"#ebdbb2"},git:{bg:"#3c3836",fg:"#b8bb26"},model:{bg:"#665c54",fg:"#83a598"},session:{bg:"#282828",fg:"#8ec07c"},block:{bg:"#3c3836",fg:"#83a598"},today:{bg:"#282828",fg:"#fabd2f"},tmux:{bg:"#282828",fg:"#fe8019"},context:{bg:"#458588",fg:"#ebdbb2"},contextLow:{bg:"#b8bb26",fg:"#282828"},contextMed:{bg:"#fabd2f",fg:"#282828"},contextHigh:{bg:"#fb4934",fg:"#282828"},metrics:{bg:"#d3869b",fg:"#282828"},version:{bg:"#504945",fg:"#8ec07c"}},Ue={directory:{bg:"#585858",fg:"#ffffaf"},git:{bg:"#444444",fg:"#afaf00"},model:{bg:"#6c6c6c",fg:"#87afaf"},session:{bg:"#303030",fg:"#87af87"},block:{bg:"#444444",fg:"#87afaf"},today:{bg:"#303030",fg:"#ffaf00"},tmux:{bg:"#303030",fg:"#ff8700"},context:{bg:"#5f8787",fg:"#ffffaf"},contextLow:{bg:"#afaf00",fg:"#303030"},contextMed:{bg:"#ffaf00",fg:"#303030"},contextHigh:{bg:"#ff5f5f",fg:"#303030"},metrics:{bg:"#d787af",fg:"#303030"},version:{bg:"#585858",fg:"#87af87"}},Ie={directory:{bg:"#808080",fg:"#ffff00"},git:{bg:"#585858",fg:"#00ff00"},model:{bg:"#808080",fg:"#00afff"},session:{bg:"#444444",fg:"#00d787"},block:{bg:"#585858",fg:"#00afff"},today:{bg:"#444444",fg:"#ffaf00"},tmux:{bg:"#444444",fg:"#ff8700"},context:{bg:"#008787",fg:"#ffffff"},contextLow:{bg:"#00af00",fg:"#000000"},contextMed:{bg:"#ffaf00",fg:"#000000"},contextHigh:{bg:"#ff0000",fg:"#ffffff"},metrics:{bg:"#ff87af",fg:"#444444"},version:{bg:"#808080",fg:"#00d787"}};var ue={dark:we,"dark-ansi256":xe,"dark-ansi":ke,light:Te,"light-ansi256":Se,"light-ansi":ve,nord:Pe,"nord-ansi256":Ee,"nord-ansi":$e,"tokyo-night":Re,"tokyo-night-ansi256":Be,"tokyo-night-ansi":Ae,"rose-pine":De,"rose-pine-ansi256":Me,"rose-pine-ansi":Fe,gruvbox:Le,"gruvbox-ansi256":Ue,"gruvbox-ansi":Ie};function q(r,e){let t=ue[r];if(!t)return null;if(e==="none"||e==="ansi"){let n=ue[`${r}-ansi`];if(n)return n}if(e==="ansi256"){let n=ue[`${r}-ansi256`];if(n)return n}return t}var l=(r,...e)=>{process.env.CLAUDE_POWERLINE_DEBUG&&console.error(`[DEBUG] ${r}`,...e);};var ot=promisify(exec),H=class{isGitRepo(e){try{return w.existsSync(_.join(e,".git"))}catch{return  false}}async execGitAsync(e,t){return ot(e,{...t,env:{...process.env,GIT_OPTIONAL_LOCKS:"0"}})}async findGitRoot(e){try{return (await this.execGitAsync("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim()||null}catch{return null}}async getGitInfo(e,t={},n){let s;if(n&&this.isGitRepo(n))s=n;else if(this.isGitRepo(e))s=e;else {let o=await this.findGitRoot(e);if(!o)return null;s=o;}try{let o=await this.getStatusWithBranchAsync(s),i=await this.getAheadBehindAsync(s),c={branch:o.branch||"detached",status:o.status,ahead:i.ahead,behind:i.behind};t.showWorkingTree&&o.workingTree&&(c.staged=o.workingTree.staged,c.unstaged=o.workingTree.unstaged,c.untracked=o.workingTree.untracked,c.conflicts=o.workingTree.conflicts);let a={},g={};t.showSha&&(a.sha=this.getShaAsync(s)),t.showTag&&(a.tag=this.getNearestTagAsync(s)),t.showTimeSinceCommit&&(a.timeSinceCommit=this.getTimeSinceLastCommitAsync(s)),t.showStashCount&&(g.stashCount=this.getStashCountAsync(s)),t.showUpstream&&(g.upstream=this.getUpstreamAsync(s)),t.showRepoName&&(g.repoName=this.getRepoNameAsync(s));let u=new Map;for(let[m,f]of Object.entries(a))try{let d=await f;u.set(m,d);}catch{}return Object.keys(g).length>0&&(await Promise.allSettled(Object.entries(g).map(async([f,d])=>({key:f,value:await d})))).forEach(f=>{f.status==="fulfilled"&&u.set(f.value.key,f.value.value);}),t.showSha&&(c.sha=u.get("sha")||void 0),t.showOperation&&(c.operation=this.getOngoingOperation(s)||void 0),t.showTag&&(c.tag=u.get("tag")||void 0),t.showTimeSinceCommit&&(c.timeSinceCommit=u.get("timeSinceCommit")||void 0),t.showStashCount&&(c.stashCount=u.get("stashCount")||0),t.showUpstream&&(c.upstream=u.get("upstream")||void 0),t.showRepoName&&(c.repoName=u.get("repoName")||void 0,c.isWorktree=this.isWorktree(s)),c}catch{return null}}async getShaAsync(e){try{return (await this.execGitAsync("git rev-parse --short=7 HEAD",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim()||null}catch{return null}}getOngoingOperation(e){try{let t=_.join(e,".git");return w.existsSync(_.join(t,"MERGE_HEAD"))?"MERGE":w.existsSync(_.join(t,"CHERRY_PICK_HEAD"))?"CHERRY-PICK":w.existsSync(_.join(t,"REVERT_HEAD"))?"REVERT":w.existsSync(_.join(t,"BISECT_LOG"))?"BISECT":w.existsSync(_.join(t,"rebase-merge"))||w.existsSync(_.join(t,"rebase-apply"))?"REBASE":null}catch{return null}}async getNearestTagAsync(e){try{return (await this.execGitAsync("git describe --tags --abbrev=0",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim()||null}catch{return null}}async getTimeSinceLastCommitAsync(e){try{let n=(await this.execGitAsync("git log -1 --format=%ct",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim();if(!n)return null;let s=parseInt(n)*1e3,o=Date.now();return Math.floor((o-s)/1e3)}catch{return null}}async getStashCountAsync(e){try{let n=(await this.execGitAsync("git stash list",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim();return n?n.split(`
`).length:0}catch{return 0}}async getUpstreamAsync(e){try{return (await this.execGitAsync("git rev-parse --abbrev-ref @{u}",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim()||null}catch{return null}}async getRepoNameAsync(e){try{let n=(await this.execGitAsync("git config --get remote.origin.url",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim();return n?n.match(/\/([^/]+?)(\.git)?$/)?.[1]||_.basename(e):_.basename(e)}catch{return _.basename(e)}}isWorktree(e){try{let t=_.join(e,".git");return !!(w.existsSync(t)&&w.statSync(t).isFile())}catch{return  false}}async getStatusWithBranchAsync(e){try{l(`[GIT-EXEC] Running git status in ${e}`);let s=(await this.execGitAsync("git status --porcelain -b",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.split(`
`),o=null,i="clean",c=0,a=0,g=0,u=0;for(let m of s)if(m){if(m.startsWith("## ")){let d=m.substring(3).split("...")[0];d&&d!=="HEAD (no branch)"&&(o=d);continue}if(m.length>=2){let f=m.charAt(0),d=m.charAt(1);if(f==="?"&&d==="?"){g++,i==="clean"&&(i="dirty");continue}let h=f+d;if(["DD","AU","UD","UA","DU","AA","UU"].includes(h)){u++,i="conflicts";continue}f!==" "&&f!=="?"&&(c++,i==="clean"&&(i="dirty")),d!==" "&&d!=="?"&&(a++,i==="clean"&&(i="dirty"));}}return {branch:o||await this.getFallbackBranch(e),status:i,workingTree:{staged:c,unstaged:a,untracked:g,conflicts:u}}}catch(t){return l(`Git status with branch command failed in ${e}:`,t),{branch:await this.getFallbackBranch(e),status:"clean"}}}async getFallbackBranch(e){try{let n=(await this.execGitAsync("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim();if(n)return n}catch{try{let n=(await this.execGitAsync("git symbolic-ref --short HEAD",{cwd:e,encoding:"utf8",timeout:2e3})).stdout.trim();if(n)return n}catch{return null}}return null}async getAheadBehindAsync(e){try{l(`[GIT-EXEC] Running git ahead/behind in ${e}`);let[t,n]=await Promise.all([this.execGitAsync("git rev-list --count @{u}..HEAD",{cwd:e,encoding:"utf8",timeout:2e3}),this.execGitAsync("git rev-list --count HEAD..@{u}",{cwd:e,encoding:"utf8",timeout:2e3})]);return {ahead:parseInt(t.stdout.trim())||0,behind:parseInt(n.stdout.trim())||0}}catch(t){return l(`Git ahead/behind command failed in ${e}:`,t),{ahead:0,behind:0}}}};var it=promisify(exec),O=class{async getSessionId(){try{if(!process.env.TMUX_PANE)return l("TMUX_PANE not set, not in tmux session"),null;l(`Getting tmux session ID, TMUX_PANE: ${process.env.TMUX_PANE}`);let t=(await it("tmux display-message -p '#S'",{encoding:"utf8",timeout:1e3})).stdout.trim();return l(`Tmux session ID: ${t||"empty"}`),t||null}catch(e){return l("Error getting tmux session ID:",e),null}}isInTmux(){return !!process.env.TMUX_PANE}};function K(){let r=[],e=process.env.CLAUDE_CONFIG_DIR;if(e&&e.split(",").forEach(t=>{let n=t.trim();existsSync(n)&&r.push(n);}),r.length===0){let t=homedir(),n=join(t,".config","claude"),s=join(t,".claude");existsSync(n)?r.push(n):existsSync(s)&&r.push(s);}return r}async function Z(r){let e=[];for(let t of r){let n=join(t,"projects");if(existsSync(n))try{let s=await readdir(n,{withFileTypes:!0});for(let o of s)if(o.isDirectory()){let i=posix.join(n,o.name);e.push(i);}}catch(s){l(`Failed to read projects directory ${n}:`,s);}}return e}async function Q(r){let e=K(),t=await Z(e);for(let n of t){let s=posix.join(n,`${r}.jsonl`);if(existsSync(s))return s}return null}async function Ne(r,e){let t=[];try{let s=(await readdir(e)).filter(o=>o.startsWith("agent-")&&o.endsWith(".jsonl"));for(let o of s){let i=posix.join(e,o);try{let a=(await readFile(i,"utf-8")).split(`
`)[0];a&&JSON.parse(a).sessionId===r&&t.push(i);}catch{l(`Failed to check agent file ${i}`);}}}catch(n){l(`Failed to read project directory ${e}:`,n);}return t}async function de(r){try{return (await stat(r)).mtime}catch{return null}}function gt(r){let e=r.message?.id||(typeof r.raw.message=="object"&&r.raw.message!==null&&"id"in r.raw.message?r.raw.message.id:void 0),t="requestId"in r.raw?r.raw.requestId:void 0;return !e||!t?null:`${e}:${t}`}var ut=1024*1024;async function M(r){try{let t=(await stat(r)).size,n;return t>ut?(l(`Using streaming parser for large file ${r} (${Math.round(t/1024)}KB)`),n=await mt(r)):n=await ft(r),l(`Parsed ${n.length} entries from ${r}`),n}catch(e){return l(`Failed to read file ${r}:`,e),[]}}async function ft(r){let t=(await readFile(r,"utf-8")).trim().split(`
`).filter(s=>s.trim()),n=[];for(let s of t)try{let o=JSON.parse(s);if(!o.timestamp)continue;let i={timestamp:new Date(o.timestamp),message:o.message,costUSD:typeof o.costUSD=="number"?o.costUSD:void 0,isSidechain:o.isSidechain===!0,raw:o};n.push(i);}catch(o){l(`Failed to parse JSONL line: ${o}`);continue}return n}async function mt(r){return new Promise((e,t)=>{let n=[],s=createReadStream(r,{encoding:"utf8"}),o=createInterface({input:s,crlfDelay:1/0});o.on("line",i=>{let c=i.trim();if(c)try{let a=JSON.parse(c);if(!a.timestamp)return;let g={timestamp:new Date(a.timestamp),message:a.message,costUSD:typeof a.costUSD=="number"?a.costUSD:void 0,isSidechain:a.isSidechain===!0,raw:a};n.push(g);}catch(a){l(`Failed to parse JSONL line: ${a}`);}}),o.on("close",()=>{e(n);}),o.on("error",i=>{l(`Streaming parser error for ${r}:`,i),t(i);}),s.on("error",i=>{l(`File stream error for ${r}:`,i),t(i);});})}async function ee(r,e,t=false){let n=K(),s=await Z(n),o=new Set,i=s.map(async h=>{try{let b=(await readdir(h)).filter(C=>C.endsWith(".jsonl")).map(async C=>{let B=posix.join(h,C);if(existsSync(B)){let $=await de(B);return {filePath:B,mtime:$}}return null});return (await Promise.all(b)).filter(C=>C?.mtime&&(!e||e(C.filePath,C.mtime)))}catch(p){return l(`Failed to read project directory ${h}:`,p),[]}}),a=(await Promise.all(i)).flat().filter(h=>h!==null);t&&a.sort((h,p)=>p.mtime.getTime()-h.mtime.getTime());let g=a.map(h=>h.filePath),u=[],m=g.map(async h=>(await M(h)).filter(y=>!r||r(y))),f=await Promise.all(m);for(let h of f)u.push(...h);u.sort((h,p)=>h.timestamp.getTime()-p.timestamp.getTime());let d=[];for(let h of u){let p=gt(h);p&&o.has(p)||(p&&o.add(p),d.push(h));}return d}var S=class{static CACHE_DIR=_.join(homedir(),".claude","powerline");static USAGE_CACHE_DIR=_.join(this.CACHE_DIR,"usage");static LOCKS_DIR=_.join(this.CACHE_DIR,"locks");static isLocked(e){let t=_.join(this.LOCKS_DIR,e);if(!w.existsSync(t))return  false;try{let n=w.readFileSync(t,"utf-8"),s=parseInt(n.trim(),10);if(isNaN(s))return l(`Invalid PID in lock file ${e}, removing stale lock`),w.unlinkSync(t),!1;try{return process.kill(s,0),!0}catch(o){return o.code==="ESRCH"?(l(`Removing stale lock file ${e} for dead process ${s}`),w.unlinkSync(t),!1):(l(`Error checking process ${s} for lock ${e}:`,o),!0)}}catch(n){return l(`Error reading lock file ${e}:`,n),true}}static async acquireLock(e,t=5e3){await this.ensureCacheDirectories();let o=_.join(this.LOCKS_DIR,e),i=Date.now(),c=String(process.pid);for(;Date.now()-i<t;)try{return await w.promises.writeFile(o,c,{flag:"wx"}),l(`Lock acquired for ${e}`),!0}catch(a){if(a.code==="EEXIST")await setTimeout(50);else throw a}return l(`Failed to acquire lock for ${e} within ${t}ms`),false}static async releaseLock(e){let t=_.join(this.LOCKS_DIR,e);try{await w.promises.unlink(t),l(`Lock released for ${e}`);}catch(n){n.code!=="ENOENT"&&l(`Error releasing lock for ${e}:`,n);}}static async ensureCacheDirectories(){try{await Promise.all([w.promises.mkdir(this.CACHE_DIR,{recursive:!0}),w.promises.mkdir(this.USAGE_CACHE_DIR,{recursive:!0}),w.promises.mkdir(this.LOCKS_DIR,{recursive:!0})]);}catch(e){l("Failed to create cache directories:",e);}}static createProjectHash(e){return createHash("md5").update(e).digest("hex").substring(0,8)}static async getUsageCache(e,t){let o="utf-8";await this.ensureCacheDirectories();let i=_.join(this.USAGE_CACHE_DIR,`${e}.json`),c=`${e}.usage.lock`;for(let a=0;a<3;a++){if(this.isLocked(c)){l(`Cache for ${e} is locked, waiting...`),await setTimeout(75);continue}try{let u=await w.promises.readFile(i,o),m=JSON.parse(u);return !t||m.timestamp>=t?(l(`[CACHE-HIT] ${e} disk cache: found`),this.deserializeDates(m.data)):(l(`${e} cache outdated: cache=${m.timestamp}, latest=${t}`),null)}catch(u){if(u.code==="ENOENT")return l(`No shared ${e} usage cache found`),null;let m=a+1;l(`Attempt ${m} failed to read ${e} cache: ${u.message}. Retrying...`),await setTimeout(75);}}return l(`Failed to read ${e} cache after 3 attempts.`),null}static deserializeDates(e){return Array.isArray(e)?e.map(t=>({...t,timestamp:new Date(t.timestamp)})):e}static async setUsageCache(e,t,n){let s=`${e}.usage.lock`;if(!await this.acquireLock(s)){l(`Could not acquire lock to set usage cache for ${e}`);return}try{await this.ensureCacheDirectories();let i=_.join(this.USAGE_CACHE_DIR,`${e}.json`),c=n||Date.now(),g=JSON.stringify({data:t,timestamp:c});await w.promises.writeFile(i,g,"utf-8"),l(`[CACHE-SET] ${e} disk cache stored`);}catch(i){l(`Failed to save ${e} usage cache:`,i);}finally{await this.releaseLock(s);}}static async getLatestTranscriptMtime(){try{let e=K(),t=await Z(e),n=0;for(let s of t)try{let i=(await w.promises.readdir(s)).filter(c=>c.endsWith(".jsonl"));for(let c of i){let a=_.join(s,c),g=await de(a);g&&g.getTime()>n&&(n=g.getTime());}}catch(o){l(`Failed to read project directory ${s}:`,o);continue}return n}catch(e){return l("Failed to get latest transcript mtime:",e),Date.now()}}};var te={"claude-3-haiku-20240307":{name:"Claude 3 Haiku",input:.25,output:1.25,cache_write_5m:.3,cache_write_1h:.5,cache_read:.03},"claude-3-5-haiku-20241022":{name:"Claude 3.5 Haiku",input:.8,output:4,cache_write_5m:1,cache_write_1h:1.6,cache_read:.08},"claude-3-5-haiku-latest":{name:"Claude 3.5 Haiku Latest",input:1,output:5,cache_write_5m:1.25,cache_write_1h:2,cache_read:.1},"claude-haiku-4-5-20251001":{name:"Claude Haiku 4.5",input:1,output:5,cache_write_5m:1.25,cache_write_1h:2,cache_read:.1},"claude-haiku-4-5":{name:"Claude Haiku 4.5",input:1,output:5,cache_write_5m:1.25,cache_write_1h:2,cache_read:.1},"claude-3-opus-latest":{name:"Claude 3 Opus Latest",input:15,output:75,cache_write_5m:18.75,cache_write_1h:30,cache_read:1.5},"claude-3-opus-20240229":{name:"Claude 3 Opus",input:15,output:75,cache_write_5m:18.75,cache_write_1h:30,cache_read:1.5},"claude-3-5-sonnet-latest":{name:"Claude 3.5 Sonnet Latest",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-3-5-sonnet-20240620":{name:"Claude 3.5 Sonnet",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-3-5-sonnet-20241022":{name:"Claude 3.5 Sonnet",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-opus-4-20250514":{name:"Claude Opus 4",input:15,output:75,cache_write_5m:18.75,cache_write_1h:30,cache_read:1.5},"claude-opus-4-1":{name:"Claude Opus 4.1",input:15,output:75,cache_write_5m:18.75,cache_write_1h:30,cache_read:1.5},"claude-opus-4-1-20250805":{name:"Claude Opus 4.1",input:15,output:75,cache_write_5m:18.75,cache_write_1h:30,cache_read:1.5},"claude-sonnet-4-20250514":{name:"Claude Sonnet 4",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-4-opus-20250514":{name:"Claude 4 Opus",input:15,output:75,cache_write_5m:18.75,cache_write_1h:30,cache_read:1.5},"claude-4-sonnet-20250514":{name:"Claude 4 Sonnet",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-sonnet-4-5":{name:"Claude Sonnet 4.5",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-sonnet-4-5-20250929":{name:"Claude Sonnet 4.5",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-3-7-sonnet-latest":{name:"Claude 3.7 Sonnet Latest",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3},"claude-3-7-sonnet-20250219":{name:"Claude 3.7 Sonnet",input:3,output:15,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3}},P=class{static executionCache=null;static modelPricingCache=new Map;static GITHUB_PRICING_URL="https://raw.githubusercontent.com/Owloops/claude-powerline/main/pricing.json";static async loadDiskCache(){let t=Date.now()-864e5;return await S.getUsageCache("pricing",t)}static async saveDiskCache(e){await S.setUsageCache("pricing",e);}static async fetchPricingData(){return new Promise(e=>{let t=new URL(this.GITHUB_PRICING_URL),n=get({hostname:t.hostname,path:t.pathname,headers:{"User-Agent":"claude-powerline","Cache-Control":"no-cache"},timeout:5e3},s=>{if(s.statusCode!==200){l(`HTTP ${s.statusCode}: ${s.statusMessage}`),e(null);return}let o="",i=0,c=1024*1024;s.on("data",a=>{if(i+=a.length,i>c){l("Response too large"),n.destroy(),e(null);return}o+=a;}),s.on("end",()=>{try{let g=JSON.parse(o),u=g._meta,m={};for(let[f,d]of Object.entries(g))f!=="_meta"&&(m[f]=d);this.validatePricingData(m)?(l(`Fetched fresh pricing from GitHub for ${Object.keys(m).length} models`),l(`Pricing last updated: ${u?.updated||"unknown"}`),e(m)):(l("Invalid pricing data structure"),e(null));}catch(a){l("Failed to parse JSON:",a),e(null);}}),s.on("error",a=>{l("Response error:",a),e(null);});});n.on("error",s=>{l("Request error:",s),e(null);}),n.on("timeout",()=>{l("Request timeout"),n.destroy(),e(null);}),n.end();})}static async getCurrentPricing(){if(this.executionCache!==null)return l(`[CACHE-HIT] Pricing execution cache: ${Object.keys(this.executionCache).length} models`),this.executionCache;let e=await this.loadDiskCache();if(e)return l(`[CACHE-HIT] Pricing disk cache: ${Object.keys(e).length} models`),this.executionCache=e,l(`[CACHE-SET] Pricing execution cache stored: ${Object.keys(e).length} models`),e;let t=await this.fetchPricingData();return t?(await this.saveDiskCache(t),l(`[CACHE-SET] Pricing disk cache stored: ${Object.keys(t).length} models`),this.executionCache=t,l(`[CACHE-SET] Pricing execution cache stored: ${Object.keys(t).length} models`),t):(l(`[CACHE-FALLBACK] Using offline pricing data: ${Object.keys(te).length} models`),this.executionCache=te,l(`[CACHE-SET] Pricing execution cache stored: ${Object.keys(te).length} models`),te)}static validatePricingData(e){if(!e||typeof e!="object")return  false;for(let[,t]of Object.entries(e)){if(!t||typeof t!="object")return  false;let n=t;if(typeof n.input!="number"||typeof n.output!="number"||typeof n.cache_read!="number")return  false}return  true}static async getModelPricing(e){if(this.modelPricingCache.has(e))return l(`[CACHE-HIT] Model pricing cache: ${e}`),this.modelPricingCache.get(e);let t=await this.getCurrentPricing(),n;return t[e]?n=t[e]:n=this.fuzzyMatchModel(e,t),this.modelPricingCache.set(e,n),l(`[CACHE-SET] Model pricing cache: ${e}`),n}static fuzzyMatchModel(e,t){let n=e.toLowerCase();for(let[o,i]of Object.entries(t))if(o.toLowerCase()===n)return i;let s=[{pattern:["opus-4-1","claude-opus-4-1"],fallback:"claude-opus-4-1-20250805"},{pattern:["opus-4","claude-opus-4"],fallback:"claude-opus-4-20250514"},{pattern:["sonnet-4.5","4-5-sonnet","sonnet-4-5"],fallback:"claude-sonnet-4-5-20250929"},{pattern:["sonnet-4","claude-sonnet-4"],fallback:"claude-sonnet-4-20250514"},{pattern:["sonnet-3.7","3-7-sonnet"],fallback:"claude-3-7-sonnet-20250219"},{pattern:["3-5-sonnet","sonnet-3.5"],fallback:"claude-3-5-sonnet-20241022"},{pattern:["haiku-4.5","4-5-haiku","haiku-4-5"],fallback:"claude-haiku-4-5-20251001"},{pattern:["3-5-haiku","haiku-3.5"],fallback:"claude-3-5-haiku-20241022"},{pattern:["haiku","3-haiku"],fallback:"claude-3-haiku-20240307"},{pattern:["opus"],fallback:"claude-opus-4-20250514"},{pattern:["sonnet"],fallback:"claude-3-5-sonnet-20241022"}];for(let{pattern:o,fallback:i}of s)if(o.some(c=>n.includes(c))&&t[i])return t[i];return t["claude-3-5-sonnet-20241022"]||{name:`${e} (Unknown Model)`,input:3,cache_write_5m:3.75,cache_write_1h:6,cache_read:.3,output:15}}static async calculateCostForEntry(e){let n=e.message?.usage;if(!n)return 0;let s=this.extractModelId(e),o=await this.getModelPricing(s),i=n.input_tokens||0,c=n.output_tokens||0,a=n.cache_creation_input_tokens||0,g=n.cache_read_input_tokens||0,u=i/1e6*o.input,m=c/1e6*o.output,f=g/1e6*o.cache_read,d=a/1e6*o.cache_write_5m;return u+m+d+f}static extractModelId(e){if(e.model&&typeof e.model=="string")return e.model;let t=e.message;if(t?.model){let n=t.model;return typeof n=="string"?n:n?.id||"claude-3-5-sonnet-20241022"}return e.model_id&&typeof e.model_id=="string"?e.model_id:"claude-3-5-sonnet-20241022"}};function Ct(r){return {timestamp:r.timestamp.toISOString(),message:{usage:{input_tokens:r.message?.usage?.input_tokens||0,output_tokens:r.message?.usage?.output_tokens||0,cache_creation_input_tokens:r.message?.usage?.cache_creation_input_tokens,cache_read_input_tokens:r.message?.usage?.cache_read_input_tokens}},costUSD:r.costUSD}}var ne=class{async getSessionUsage(e){try{let t=await Q(e);if(!t)return l(`No transcript found for session: ${e}`),null;l(`Found transcript at: ${t}`);let n=await M(t),s=dirname(t),o=await Ne(e,s);l(`Found ${o.length} agent transcripts for session`);for(let a of o){let g=await M(a);n.push(...g);}if(n.length===0)return {totalCost:0,entries:[]};let i=[],c=0;for(let a of n)if(a.message?.usage){let g=Ct(a);if(g.costUSD!==void 0)c+=g.costUSD;else {let u=await P.calculateCostForEntry(a.raw);g.costUSD=u,c+=u;}i.push(g);}return l(`Parsed ${i.length} usage entries, total cost: $${c.toFixed(4)}`),{totalCost:c,entries:i}}catch(t){return l(`Error reading session usage for ${e}:`,t),null}}calculateTokenBreakdown(e){return e.reduce((t,n)=>({input:t.input+(n.message.usage.input_tokens||0),output:t.output+(n.message.usage.output_tokens||0),cacheCreation:t.cacheCreation+(n.message.usage.cache_creation_input_tokens||0),cacheRead:t.cacheRead+(n.message.usage.cache_read_input_tokens||0)}),{input:0,output:0,cacheCreation:0,cacheRead:0})}detectCompactCount(e){if(e.length<2)return 0;let t=0,n=0;for(let s of e){let o=s.message.usage.input_tokens||0;n>1e4&&o<n*.5&&(t++,l(`Detected compaction: ${n} -> ${o} tokens`)),n=o;}return t}async getSessionInfo(e,t){let n=await this.getSessionUsage(e);if(!n||n.entries.length===0)return {cost:null,calculatedCost:null,officialCost:null,tokens:null,tokenBreakdown:null,compactCount:0,messageCount:0,baselineTokens:null,currentInputTokens:null};let s=this.calculateTokenBreakdown(n.entries),o=s.input+s.output+s.cacheCreation+s.cacheRead,i=n.totalCost,c=t?.cost?.total_cost_usd??null,a=i??c,g=this.detectCompactCount(n.entries),u=n.entries[0],m=n.entries[n.entries.length-1],f=y=>{if(!y)return null;let b=y.message.usage;return (b.input_tokens||0)+(b.cache_creation_input_tokens||0)+(b.cache_read_input_tokens||0)},d=f(u),h=f(m),p=n.entries.length;return {cost:a,calculatedCost:i,officialCost:c,tokens:o,tokenBreakdown:s,compactCount:g,messageCount:p,baselineTokens:d,currentInputTokens:h}}},N=class{sessionProvider=new ne;async getUsageInfo(e,t){try{return l(`Starting usage info retrieval for session: ${e}`),{session:await this.sessionProvider.getSessionInfo(e,t)}}catch(n){return l(`Error getting usage info for session ${e}:`,n),{session:{cost:null,calculatedCost:null,officialCost:null,tokens:null,tokenBreakdown:null,compactCount:0,messageCount:0,baselineTokens:null,currentInputTokens:null}}}}};var j=class{thresholds={LOW:50,MEDIUM:80};config;constructor(e){this.config=e;}getContextUsageThresholds(){return this.thresholds}getContextLimit(e){let t=this.config.modelContextLimits||{default:2e5},n=this.getModelType(e);return t[n]||t.default||2e5}getModelType(e){let t=e.toLowerCase();return t.includes("sonnet")?"sonnet":t.includes("opus")?"opus":"default"}calculatePercentages(e,t){let n=Math.min(100,Math.max(0,Math.round(e/t*100))),s=Math.round(t*.75),o=Math.min(100,Math.max(0,Math.round(e/s*100))),i=Math.max(0,100-o);return {percentage:n,usablePercentage:o,contextLeftPercentage:i,usableTokens:s}}calculateContextFromHookData(e){let t=e.context_window?.current_usage;if(!t)return l("No current_usage in hook data, falling back to transcript parsing"),null;let n=e.context_window?.context_window_size||2e5,s=(t.input_tokens||0)+(t.cache_creation_input_tokens||0)+(t.cache_read_input_tokens||0);l(`Native current_usage: input=${t.input_tokens}, cache_create=${t.cache_creation_input_tokens}, cache_read=${t.cache_read_input_tokens}, total=${s} (limit: ${n})`);let o=this.calculatePercentages(s,n);return {totalTokens:s,maxTokens:n,...o}}async calculateContextTokensFromTranscript(e,t){try{l(`Calculating context tokens from transcript: ${e}`);try{if(!readFileSync(e,"utf-8"))return l("Transcript file is empty"),null}catch{return l("Could not read transcript file"),null}let n=await M(e);if(n.length===0)return l("No entries in transcript"),null;let s=null;for(let o=n.length-1;o>=0;o--){let i=n[o];if(i&&i.message?.usage?.input_tokens&&i.isSidechain!==!0){s=i,l(`Context segment: Found most recent entry at ${i.timestamp.toISOString()}, stopping search`);break}}if(s?.message?.usage){let o=s.message.usage,i=(o.input_tokens||0)+(o.cache_read_input_tokens||0)+(o.cache_creation_input_tokens||0),c=t?this.getContextLimit(t):2e5;l(`Most recent main chain context: ${i} tokens (limit: ${c})`);let a=this.calculatePercentages(i,c);return {totalTokens:i,maxTokens:c,...a}}return l("No main chain entries with usage data found"),null}catch(n){return l(`Error reading transcript: ${n instanceof Error?n.message:String(n)}`),null}}async getContextInfo(e){let t=this.calculateContextFromHookData(e);return t||this.calculateContextTokensFromTranscript(e.transcript_path,e.model?.id)}};var G=class{async loadTranscriptEntries(e){try{let t=await Q(e);if(!t)return l(`No transcript found for session: ${e}`),[];l(`Loading transcript from: ${t}`);let s=(await readFile(t,"utf-8")).trim().split(`
`).filter(i=>i.trim()),o=[];for(let i of s)try{let c=JSON.parse(i);if(c.isSidechain===!0)continue;o.push(c);}catch(c){l(`Failed to parse JSONL line: ${c}`);continue}return l(`Loaded ${o.length} transcript entries`),o}catch(t){return l(`Error loading transcript for ${e}:`,t),[]}}calculateMessageCount(e){return e.filter(t=>{let n=t.type||t.message?.role||t.message?.type,s=t.type==="user"&&t.message?.content?.[0]?.type==="tool_result";return n==="user"&&!s}).length}calculateLastResponseTime(e){if(e.length===0)return null;let t=e.slice(-20),n=null,s=null;for(let o of t)if(o.timestamp)try{let i=new Date(o.timestamp),c=o.type||o.message?.role||o.message?.type,a=o.type==="user"&&o.message?.content?.[0]?.type==="tool_result";if(c==="user"&&!a)n=i;else if(c==="assistant"&&n){let u=(i.getTime()-n.getTime())/1e3;u>.1&&u<300&&(s=u);}}catch{continue}return s}async getMetricsInfo(e,t){try{if(l(`Getting metrics from hook data for session: ${e}`),!t.cost)return l("No cost data available in hook data"),{responseTime:null,lastResponseTime:null,sessionDuration:null,messageCount:null,linesAdded:null,linesRemoved:null};let n=await this.loadTranscriptEntries(e),s=this.calculateMessageCount(n),o=this.calculateLastResponseTime(n);return {responseTime:t.cost.total_api_duration_ms/1e3,lastResponseTime:o,sessionDuration:t.cost.total_duration_ms/1e3,messageCount:s,linesAdded:t.cost.total_lines_added,linesRemoved:t.cost.total_lines_removed}}catch(n){return l(`Error getting metrics from hook data for session ${e}:`,n),{responseTime:null,lastResponseTime:null,sessionDuration:null,messageCount:null,linesAdded:null,linesRemoved:null}}}};function oe(r){return r===null?"$0.00":r<.01?"<$0.01":`$${r.toFixed(2)}`}function v(r){return r===null||r===0?"0 tokens":r>=1e6?`${(r/1e6).toFixed(1)}M tokens`:r>=1e3?`${(r/1e3).toFixed(1)}K tokens`:`${r} tokens`}function je(r){if(!r)return "0 tokens";let e=[];if(r.input>0&&e.push(`${v(r.input).replace(" tokens","")}in`),r.output>0&&e.push(`${v(r.output).replace(" tokens","")}out`),r.cacheCreation>0||r.cacheRead>0){let t=r.cacheCreation+r.cacheRead;e.push(`${v(t).replace(" tokens","")}cached`);}return e.length>0?e.join(" + "):"0 tokens"}function Ge(r){return r<60?`${r}s`:r<3600?`${Math.floor(r/60)}m`:r<86400?`${Math.floor(r/3600)}h`:r<604800?`${Math.floor(r/86400)}d`:`${Math.floor(r/604800)}w`}function We(r){return r<60?`${r.toFixed(0)}s`:r<3600?`${(r/60).toFixed(0)}m`:r<86400?`${(r/3600).toFixed(1)}h`:`${(r/86400).toFixed(1)}d`}function xt(r,e){return !e||e<=0||r<0?null:Math.min(100,r/e*100)}function pe(r,e,t=80){let n=xt(r,e);if(n===null)return {percentage:null,isWarning:false,displayText:""};let s=`${n.toFixed(0)}%`,o=n>=t,i="";return o?i=` !${s}`:n>=50?i=` +${s}`:i=` ${s}`,{percentage:n,isWarning:o,displayText:i}}var W=class{constructor(e,t){this.config=e;this.symbols=t;}renderDirectory(e,t,n){let s=e.workspace?.current_dir||e.cwd||"/",o=e.workspace?.project_dir,i=n?.style??(n?.showBasename?"basename":"full");if(i==="basename")return {text:_.basename(s)||"root",bgColor:t.modeBg,fgColor:t.modeFg};let c=process.env.HOME||process.env.USERPROFILE,a=s,g=o;c&&(s.startsWith(c)&&(a=s.replace(c,"~")),o&&o.startsWith(c)&&(g=o.replace(c,"~")));let u=this.getDisplayDirectoryName(a,g);return i==="fish"&&(u=this.abbreviateFishStyle(u)),{text:u,bgColor:t.modeBg,fgColor:t.modeFg}}renderGit(e,t,n){if(!e)return null;let s=[];if(n?.showRepoName&&e.repoName&&(s.push(e.repoName),e.isWorktree&&s.push(this.symbols.git_worktree)),n?.showOperation&&e.operation&&s.push(`[${e.operation}]`),s.push(`${this.symbols.branch} ${e.branch}`),n?.showTag&&e.tag&&s.push(`${this.symbols.git_tag} ${e.tag}`),n?.showSha&&e.sha&&s.push(`${this.symbols.git_sha} ${e.sha}`),n?.showAheadBehind!==false&&(e.ahead>0&&e.behind>0?s.push(`${this.symbols.git_ahead}${e.ahead}${this.symbols.git_behind}${e.behind}`):e.ahead>0?s.push(`${this.symbols.git_ahead}${e.ahead}`):e.behind>0&&s.push(`${this.symbols.git_behind}${e.behind}`)),n?.showWorkingTree){let i=[];e.staged&&e.staged>0&&i.push(`+${e.staged}`),e.unstaged&&e.unstaged>0&&i.push(`~${e.unstaged}`),e.untracked&&e.untracked>0&&i.push(`?${e.untracked}`),e.conflicts&&e.conflicts>0&&i.push(`!${e.conflicts}`),i.length>0&&s.push(`(${i.join(" ")})`);}if(n?.showUpstream&&e.upstream&&s.push(`${this.symbols.git_upstream}${e.upstream}`),n?.showStashCount&&e.stashCount&&e.stashCount>0&&s.push(`${this.symbols.git_stash} ${e.stashCount}`),n?.showTimeSinceCommit&&e.timeSinceCommit!==void 0){let i=Ge(e.timeSinceCommit);s.push(`${this.symbols.git_time} ${i}`);}let o=this.symbols.git_clean;return e.status==="conflicts"?o=this.symbols.git_conflicts:e.status==="dirty"&&(o=this.symbols.git_dirty),s.push(o),{text:s.join(" "),bgColor:t.gitBg,fgColor:t.gitFg}}renderModel(e,t){let n=e.model?.display_name||"Claude";return {text:`${this.symbols.model} ${n}`,bgColor:t.modelBg,fgColor:t.modelFg}}renderSession(e,t,n){let s=n?.type||"cost",o=n?.costSource,i=this.config.budget?.session,c=()=>o==="calculated"?e.session.calculatedCost:o==="official"?e.session.officialCost:e.session.cost,a=e.session.messageCount||0,g=e.session.compactCount||0,u="";a>0&&(u+=` \xB7 ${a} msgs`),n?.showCompactCount!==false&&g>0&&(u+=` \xB7 ${g}${this.symbols.compact}`);let m;if(s==="tokens"&&e.session.tokenBreakdown){let d=this.formatCompactTokens(e.session.tokenBreakdown.input),h=this.formatCompactTokens(e.session.tokenBreakdown.output),p=this.formatCompactTokens(e.session.tokenBreakdown.input+e.session.tokenBreakdown.output);m=`${d}\u2193 ${h}\u2191 (${p})`;}else m=this.formatUsageWithBudget(c(),e.session.tokens,e.session.tokenBreakdown,s,i?.amount,i?.warningThreshold||80,i?.type);return {text:`Session ${m}${u}`,bgColor:t.sessionBg,fgColor:t.sessionFg}}renderTmux(e,t){return e?{text:`tmux:${e}`,bgColor:t.tmuxBg,fgColor:t.tmuxFg}:{text:"tmux:none",bgColor:t.tmuxBg,fgColor:t.tmuxFg}}renderContext(e,t,n){if(!e)return {text:n?.style==="bar"?`Context ${this.generateContextBar(0,n?.barWidth||10)}${n?.showBarPercentage!==false?" 0%":""}`:"Context 0 (100%)",bgColor:t.contextLowBg||t.contextBg,fgColor:t.contextLowFg||t.contextFg};let s=100-e.contextLeftPercentage,o=n?.thresholds||{low:50,high:80},i=o.low??50,c=o.high??80,a,g;s>=c?(a=t.contextHighBg||t.contextBg,g=t.contextHighFg||t.contextFg):s>=i?(a=t.contextMedBg||t.contextBg,g=t.contextMedFg||t.contextFg):(a=t.contextLowBg||t.contextBg,g=t.contextLowFg||t.contextFg);let u;if(n?.style==="bar"){let m=n?.barWidth||10,f=this.generateContextBar(s,m),d=n?.showBarPercentage!==false?` ${Math.round(s)}%`:"",h=n?.showBarTokens!==false?` \xB7 ${this.formatCompactTokens(e.totalTokens)}`:"";u=`Context ${f}${d}${h}`;}else {let m=`${e.contextLeftPercentage}%`;u=n?.showPercentageOnly?`Context ${m}`:`Context ${e.totalTokens.toLocaleString()} (${m})`;}return {text:u,bgColor:a,fgColor:g}}generateContextBar(e,t){let n=Math.round(e/100*t),s=t-n,o=this.symbols.progress_filled.repeat(n),i=this.symbols.progress_empty.repeat(s);return `${this.symbols.progress_left_bracket}${o}${i}${this.symbols.progress_right_bracket}`}formatCompactTokens(e){return e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toString()}renderMetrics(e,t,n,s){if(!e)return {text:`${this.symbols.metrics_response} new`,bgColor:t.metricsBg,fgColor:t.metricsFg};let o=[];if(s?.showLastResponseTime&&e.lastResponseTime!==null){let i=e.lastResponseTime<60?`${e.lastResponseTime.toFixed(1)}s`:`${(e.lastResponseTime/60).toFixed(1)}m`;o.push(`${this.symbols.metrics_last_response} ${i}`);}if(s?.showResponseTime!==false&&e.responseTime!==null){let i=e.responseTime<60?`${e.responseTime.toFixed(1)}s`:`${(e.responseTime/60).toFixed(1)}m`;o.push(`${this.symbols.metrics_response} ${i}`);}if(s?.showDuration!==false&&e.sessionDuration!==null){let i=We(e.sessionDuration);o.push(`${this.symbols.metrics_duration} ${i}`);}return s?.showMessageCount!==false&&e.messageCount!==null&&o.push(`${this.symbols.metrics_messages} ${e.messageCount}`),s?.showLinesAdded!==false&&e.linesAdded!==null&&e.linesAdded>0&&o.push(`${this.symbols.metrics_lines_added} ${e.linesAdded}`),s?.showLinesRemoved!==false&&e.linesRemoved!==null&&e.linesRemoved>0&&o.push(`${this.symbols.metrics_lines_removed} ${e.linesRemoved}`),o.length===0?{text:`${this.symbols.metrics_response} active`,bgColor:t.metricsBg,fgColor:t.metricsFg}:{text:o.join(" "),bgColor:t.metricsBg,fgColor:t.metricsFg}}renderBlock(e,t,n){let s;if(e.cost===null&&e.tokens===null)s="No active block";else {let o=n?.type||"cost",i=n?.burnType,c=this.config.budget?.block,a=e.timeRemaining!==null?(()=>{let m=Math.floor(e.timeRemaining/60),f=e.timeRemaining%60;return m>0?`${m}h ${f}m`:`${f}m`})():null,g;switch(o){case "cost":g=this.formatUsageWithBudget(e.cost,null,null,"cost",c?.amount,c?.warningThreshold,c?.type);break;case "tokens":g=this.formatUsageWithBudget(null,e.tokens,null,"tokens",c?.amount,c?.warningThreshold,c?.type);break;case "weighted":let m=c?.type==="tokens"?c.amount:void 0,f=v(e.weightedTokens);if(m&&e.weightedTokens!==null){let d=pe(e.weightedTokens,m,c?.warningThreshold||80);g=`${f}${d.displayText}`;}else g=`${f} (weighted)`;break;case "both":g=this.formatUsageWithBudget(e.cost,e.tokens,null,"both",c?.amount,c?.warningThreshold,c?.type);break;case "time":g=a||"N/A";break;default:g=this.formatUsageWithBudget(e.cost,null,null,"cost",c?.amount,c?.warningThreshold,c?.type);}let u="";if(i&&i!=="none")switch(i){case "cost":u=` | ${e.burnRate!==null?e.burnRate<1?`${(e.burnRate*100).toFixed(0)}\xA2/h`:`$${e.burnRate.toFixed(2)}/h`:"N/A"}`;break;case "tokens":u=` | ${e.tokenBurnRate!==null?`${v(Math.round(e.tokenBurnRate))}/h`:"N/A"}`;break;case "both":let d=e.burnRate!==null?e.burnRate<1?`${(e.burnRate*100).toFixed(0)}\xA2/h`:`$${e.burnRate.toFixed(2)}/h`:"N/A",h=e.tokenBurnRate!==null?`${v(Math.round(e.tokenBurnRate))}/h`:"N/A";u=` | ${d} / ${h}`;break}o==="time"?s=g:s=a?`${g}${u} (${a} left)`:`${g}${u}`;}return {text:`${this.symbols.block_cost} ${s}`,bgColor:t.blockBg,fgColor:t.blockFg}}renderToday(e,t,n="cost"){let s=this.config.budget?.today;return {text:`${this.symbols.today_cost} ${this.formatUsageWithBudget(e.cost,e.tokens,e.tokenBreakdown,n,s?.amount,s?.warningThreshold,s?.type)}`,bgColor:t.todayBg,fgColor:t.todayFg}}getDisplayDirectoryName(e,t){return e.startsWith("~")?e:t&&t!==e?e.startsWith(t)?e.slice(t.length+1)||_.basename(t)||"project":_.basename(e)||"root":_.basename(e)||"root"}abbreviateFishStyle(e){let t=e.split(_.sep);return t.map((n,s)=>s===t.length-1||n==="~"||n===""?n:n.charAt(0)).join(_.sep)}formatUsageDisplay(e,t,n,s){switch(s){case "cost":return oe(e);case "tokens":return v(t);case "both":return `${oe(e)} (${v(t)})`;case "breakdown":return je(n);default:return oe(e)}}formatUsageWithBudget(e,t,n,s,o,i=80,c){let a=this.formatUsageDisplay(e,t,n,s);if(o&&o>0){let g=null;if(c==="tokens"&&t!==null?g=t:(c==="cost"&&e!==null||!c&&e!==null)&&(g=e),g!==null){let u=pe(g,o,i);return a+u.displayText}}return a}renderVersion(e,t,n){return e.version?{text:`${this.symbols.version} v${e.version}`,bgColor:t.versionBg,fgColor:t.versionFg}:null}};function kt(r){return r.includes("opus")?5:(r.includes("sonnet")||r.includes("haiku"),1)}function Tt(r){return {timestamp:r.timestamp,usage:{inputTokens:r.message?.usage?.input_tokens||0,outputTokens:r.message?.usage?.output_tokens||0,cacheCreationInputTokens:r.message?.usage?.cache_creation_input_tokens||0,cacheReadInputTokens:r.message?.usage?.cache_read_input_tokens||0},costUSD:r.costUSD||0,model:r.message?.model||"unknown"}}var se=class{sessionDurationHours=5;floorToHour(e){let t=new Date(e);return t.setUTCMinutes(0,0,0),t}identifySessionBlocks(e){if(e.length===0)return [];let t=this.sessionDurationHours*60*60*1e3,n=[],s=[...e].sort((c,a)=>c.timestamp.getTime()-a.timestamp.getTime()),o=null,i=[];for(let c of s){let a=c.timestamp;if(o==null)o=this.floorToHour(a),i=[c];else {let g=a.getTime()-o.getTime(),u=i[i.length-1];if(u==null)continue;let m=u.timestamp,f=a.getTime()-m.getTime();g>t||f>t?(n.push(i),o=this.floorToHour(a),i=[c]):i.push(c);}}return o!=null&&i.length>0&&n.push(i),n}createBlockInfo(e,t){let n=new Date,s=this.sessionDurationHours*60*60*1e3,o=new Date(e.getTime()+s),i=t[t.length-1],c=i!=null?i.timestamp:e,a=n.getTime()-c.getTime()<s&&n<o;return {block:t,isActive:a}}findActiveBlock(e){for(let t=e.length-1;t>=0;t--){let n=e[t];if(!n||n.length===0)continue;let s=n[0];if(!s)continue;let o=this.floorToHour(s.timestamp),i=this.createBlockInfo(o,n);if(i.isActive)return i.block}return null}async loadUsageEntries(){try{l("Block segment: Loading entries for dynamic session blocks");let e=new Date;e.setDate(e.getDate()-1);let n=await ee(void 0,(a,g)=>g>=e,!0),s=[];for(let a of n)if(a.message?.usage){let g=Tt(a);!g.costUSD&&a.raw&&(g.costUSD=await P.calculateCostForEntry(a.raw)),s.push(g);}let o=this.identifySessionBlocks(s);l(`Block segment: Found ${o.length} session blocks`);let i=this.findActiveBlock(o),c=[];if(i&&i.length>0){l(`Block segment: Found active block with ${i.length} entries`);let a=i[0],g=i[i.length-1];a&&g&&l(`Block segment: Active block from ${a.timestamp.toISOString()} to ${g.timestamp.toISOString()}`),c=i;}else l("Block segment: No active block found"),c=[];return c}catch(e){return l("Error loading block entries:",e),[]}}async getActiveBlockInfo(){try{let e=await this.loadUsageEntries();if(e.length===0)return l("Block segment: No entries in current block"),{cost:null,tokens:null,weightedTokens:null,timeRemaining:null,burnRate:null,tokenBurnRate:null};let t=e.reduce((g,u)=>g+u.costUSD,0),n=e.reduce((g,u)=>g+u.usage.inputTokens+u.usage.outputTokens+u.usage.cacheCreationInputTokens+u.usage.cacheReadInputTokens,0),s=e.reduce((g,u)=>{let m=u.usage.inputTokens+u.usage.outputTokens+u.usage.cacheCreationInputTokens+u.usage.cacheReadInputTokens,f=kt(u.model);return g+m*f},0),o=new Date,i=null;if(e.length>0){let g=e[0];if(g){let u=this.sessionDurationHours*60*60*1e3,m=this.floorToHour(g.timestamp),f=new Date(m.getTime()+u);i=Math.max(0,Math.round((f.getTime()-o.getTime())/(1e3*60)));}}let c=null,a=null;if(e.length>=1&&(t>0||n>0)){let g=e.map(f=>f.timestamp).sort((f,d)=>f.getTime()-d.getTime()),u=g[0],m=g[g.length-1];if(u&&m){let f=(m.getTime()-u.getTime())/6e4;f>0&&(t>0&&(c=t/f*60),n>0&&(a=n/f*60));}}return l(`Block segment: $${t.toFixed(2)}, ${n} tokens, ${i}m remaining, burn rate: ${c?"$"+c.toFixed(2)+"/hr":"N/A"}`),{cost:t,tokens:n,weightedTokens:s,timeRemaining:i,burnRate:c,tokenBurnRate:a}}catch(e){return l("Error getting active block info:",e),{cost:null,tokens:null,weightedTokens:null,timeRemaining:null,burnRate:null,tokenBurnRate:null}}}};function V(r){let e=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),n=String(r.getDate()).padStart(2,"0");return `${e}-${t}-${n}`}function St(r){return r.inputTokens+r.outputTokens+r.cacheCreationInputTokens+r.cacheReadInputTokens}function vt(r){return {timestamp:r.timestamp,usage:{inputTokens:r.message?.usage?.input_tokens||0,outputTokens:r.message?.usage?.output_tokens||0,cacheCreationInputTokens:r.message?.usage?.cache_creation_input_tokens||0,cacheReadInputTokens:r.message?.usage?.cache_read_input_tokens||0},costUSD:r.costUSD||0,model:r.message?.model||"unknown"}}var re=class{async loadTodayEntries(){let t=V(new Date);l(`Today segment: Loading entries for date ${t}`);let n=await S.getLatestTranscriptMtime(),s=await S.getUsageCache("today",n);if(s)return l("Using shared today usage cache"),s;let o=new Date;o.setDate(o.getDate()-1),o.setHours(0,0,0,0);let i=(f,d)=>d>=o,c=new Date;c.setHours(0,0,0,0);let g=await ee(f=>f.timestamp>=c,i,true),u=[],m=0;for(let f of g)if(V(f.timestamp)===t&&f.message?.usage){let h=vt(f);!h.costUSD&&f.raw&&(h.costUSD=await P.calculateCostForEntry(f.raw)),u.push(h),m++;}return l(`Today segment: Found ${m} entries for today (${t})`),await S.setUsageCache("today",u,n),u}async getTodayEntries(){try{return await this.loadTodayEntries()}catch(e){return l("Error loading today's entries:",e),[]}}async getTodayInfo(){try{let e=await this.getTodayEntries();if(e.length===0)return {cost:null,tokens:null,tokenBreakdown:null,date:V(new Date)};let t=e.reduce((o,i)=>o+i.costUSD,0),n=e.reduce((o,i)=>o+St(i.usage),0),s=e.reduce((o,i)=>({input:o.input+i.usage.inputTokens,output:o.output+i.usage.outputTokens,cacheCreation:o.cacheCreation+i.usage.cacheCreationInputTokens,cacheRead:o.cacheRead+i.usage.cacheReadInputTokens}),{input:0,output:0,cacheCreation:0,cacheRead:0});return l(`Today segment: $${t.toFixed(2)}, ${n} tokens total`),{cost:t,tokens:n,tokenBreakdown:s,date:V(new Date)}}catch(e){return l("Error getting today's info:",e),{cost:null,tokens:null,tokenBreakdown:null,date:V(new Date)}}}};var Ve="\x1B[0m",Ye={right:"\uE0B0",left_rounded:"\uE0B6",right_rounded:"\uE0B4",branch:"\u2387",model:"\u2731",git_clean:"\u2713",git_dirty:"\u25CF",git_conflicts:"\u26A0",git_ahead:"\u2191",git_behind:"\u2193",git_worktree:"\u29C9",git_tag:"\u2302",git_sha:"\u266F",git_upstream:"\u2192",git_stash:"\u29C7",git_time:"\u25F7",session_cost:"\xA7",block_cost:"\u25F1",today_cost:"\u2609",context_time:"\u25D4",metrics_response:"\u29D6",metrics_last_response:"\u0394",metrics_duration:"\u29D7",metrics_messages:"\u27D0",metrics_lines_added:"+",metrics_lines_removed:"-",metrics_burn:"\u27E2",version:"\u25C8",progress_filled:"\u2588",progress_empty:"\u2591",progress_left_bracket:"[",progress_right_bracket:"]",compact:"\u27F2"},Je={right:"\uE0B0",left_rounded:"\uE0B6",right_rounded:"\uE0B4",branch:"~",model:"M",git_clean:"=",git_dirty:"*",git_conflicts:"!",git_ahead:"^",git_behind:"v",git_worktree:"W",git_tag:"T",git_sha:"#",git_upstream:">>",git_stash:"S",git_time:"@",session_cost:"S",block_cost:"B",today_cost:"D",context_time:"C",metrics_response:"R",metrics_last_response:"L",metrics_duration:"T",metrics_messages:"#",metrics_lines_added:"+",metrics_lines_removed:"-",metrics_burn:"~/h",version:"V",progress_filled:"#",progress_empty:"-",progress_left_bracket:"[",progress_right_bracket:"]",compact:"C"};var Pt="\x1B",Et=new RegExp(`${Pt}\\[[0-9;]*m`,"g"),$t=/^[a-zA-Z0-9/]+$/;function Rt(){if(process.platform==="win32")return null;let r=process.pid.toString();for(let e=0;e<10;e++)try{let n=execSync(`ps -o ppid=,tty= -p ${r}`,{encoding:"utf8",stdio:["pipe","pipe","ignore"]}).trim().split(/\s+/),s=n[0],o=n[1];if(o&&o!=="?"&&o!=="??"&&$t.test(o))return o;if(!s||s==="1"||s==="0")break;r=s;}catch{break}return null}function Bt(){try{let e=execSync("mode con",{encoding:"utf8",stdio:["pipe","pipe","ignore"],windowsHide:!0}).match(/Columns:\s*(\d+)/i);if(e?.[1]){let t=parseInt(e[1],10);if(!isNaN(t)&&t>0)return t}}catch{}return null}function At(){let r=Rt();if(r)try{let t=execSync(`stty size < /dev/${r}`,{encoding:"utf8",stdio:["pipe","pipe","ignore"],shell:"/bin/sh"}).trim().split(" ")[1];if(t){let n=parseInt(t,10);if(!isNaN(n)&&n>0)return n}}catch{}try{let e=execSync("tput cols 2>/dev/null",{encoding:"utf8",stdio:["pipe","pipe","ignore"]}).trim(),t=parseInt(e,10);if(!isNaN(t)&&t>0)return t}catch{}return null}function ze(){let r=n=>Math.floor(n*.8),e=process.env.COLUMNS;if(e){let n=parseInt(e,10);if(!isNaN(n)&&n>0)return r(n)}if(process.stdout.columns&&process.stdout.columns>0)return r(process.stdout.columns);if(process.platform==="win32"){let n=Bt();if(n)return r(n)}let t=At();return t?r(t):null}function Dt(r){return r.replace(Et,"")}function qe(r){return Dt(r).length}var ae=class{constructor(e){this.config=e;this.symbols=this.initializeSymbols();}symbols;_usageProvider;_blockProvider;_todayProvider;_contextProvider;_gitService;_tmuxService;_metricsProvider;_segmentRenderer;get usageProvider(){return this._usageProvider||(this._usageProvider=new N),this._usageProvider}get blockProvider(){return this._blockProvider||(this._blockProvider=new se),this._blockProvider}get todayProvider(){return this._todayProvider||(this._todayProvider=new re),this._todayProvider}get contextProvider(){return this._contextProvider||(this._contextProvider=new j(this.config)),this._contextProvider}get gitService(){return this._gitService||(this._gitService=new H),this._gitService}get tmuxService(){return this._tmuxService||(this._tmuxService=new O),this._tmuxService}get metricsProvider(){return this._metricsProvider||(this._metricsProvider=new G),this._metricsProvider}get segmentRenderer(){return this._segmentRenderer||(this._segmentRenderer=new W(this.config,this.symbols)),this._segmentRenderer}needsSegmentInfo(e){return this.config.display.lines.some(t=>t.segments[e]?.enabled)}async generateStatusline(e){let t=this.needsSegmentInfo("session")?await this.usageProvider.getUsageInfo(e.session_id,e):null,n=this.needsSegmentInfo("block")?await this.blockProvider.getActiveBlockInfo():null,s=this.needsSegmentInfo("today")?await this.todayProvider.getTodayInfo():null,o=this.needsSegmentInfo("context")?await this.contextProvider.getContextInfo(e):null,i=this.needsSegmentInfo("metrics")?await this.metricsProvider.getMetricsInfo(e.session_id,e):null;return this.config.display.autoWrap?this.generateAutoWrapStatusline(e,t,n,s,o,i):(await Promise.all(this.config.display.lines.map(a=>this.renderLine(a,e,t,n,s,o,i)))).filter(a=>a.length>0).join(`
`)}async generateAutoWrapStatusline(e,t,n,s,o,i){let c=this.getThemeColors(),a=e.workspace?.current_dir||e.cwd||"/",g=ze(),u=[];for(let m of this.config.display.lines){let f=Object.entries(m.segments).filter(([y,b])=>b?.enabled).map(([y,b])=>({type:y,config:b})),d=[];for(let y of f){let b=await this.renderSegment(y,e,t,n,s,o,i,c,a);b&&d.push({type:y.type,text:b.text,bgColor:b.bgColor,fgColor:b.fgColor});}if(d.length===0)continue;if(!g||g<=0){u.push(this.buildLineFromSegments(d,c));continue}let h=[],p=0;for(let y of d){let b=this.calculateSegmentWidth(y,h.length===0);h.length>0&&p+b>g&&(u.push(this.buildLineFromSegments(h,c)),h=[],p=0),h.push(y),p+=b;}h.length>0&&u.push(this.buildLineFromSegments(h,c));}return u.join(`
`)}calculateSegmentWidth(e,t){let n=this.config.display.style==="capsule",s=qe(e.text),i=(this.config.display.padding??1)*2;if(n){let a=2+i+(t?0:1);return s+a}let c=1+i;return s+c}buildLineFromSegments(e,t){let n=this.config.display.style==="capsule",s=t.reset;for(let o=0;o<e.length;o++){let i=e[o];if(!i)continue;let c=o===0,a=o===e.length-1,g=a?null:e[o+1],u=g?this.getSegmentBgColor(g.type,t):"";n&&!c&&(s+=" "),s+=this.formatSegment(i.bgColor,i.fgColor,i.text,a?void 0:u,t);}return s}async renderLine(e,t,n,s,o,i,c){let a=this.getThemeColors(),g=t.workspace?.current_dir||t.cwd||"/",u=Object.entries(e.segments).filter(([d,h])=>h?.enabled).map(([d,h])=>({type:d,config:h})),m=this.config.display.style==="capsule",f=a.reset;for(let d=0;d<u.length;d++){let h=u[d];if(!h)continue;let p=d===0,y=d===u.length-1,b=y?null:u[d+1],E=b?this.getSegmentBgColor(b.type,a):"",C=await this.renderSegment(h,t,n,s,o,i,c,a,g);C&&(m&&!p&&(f+=" "),f+=this.formatSegment(C.bgColor,C.fgColor,C.text,y?void 0:E,a));}return f}async renderSegment(e,t,n,s,o,i,c,a,g){return e.type==="directory"?this.segmentRenderer.renderDirectory(t,a,e.config):e.type==="model"?this.segmentRenderer.renderModel(t,a):e.type==="git"?await this.renderGitSegment(e.config,t,a,g):e.type==="session"?this.renderSessionSegment(e.config,n,a):e.type==="tmux"?await this.renderTmuxSegment(a):e.type==="context"?this.renderContextSegment(e.config,i,a):e.type==="metrics"?this.renderMetricsSegment(e.config,c,s,a):e.type==="block"?this.renderBlockSegment(e.config,s,a):e.type==="today"?this.renderTodaySegment(e.config,o,a):e.type==="version"?this.renderVersionSegment(e.config,t,a):null}async renderGitSegment(e,t,n,s){if(!this.needsSegmentInfo("git"))return null;let o=await this.gitService.getGitInfo(s,{showSha:e?.showSha,showWorkingTree:e?.showWorkingTree,showOperation:e?.showOperation,showTag:e?.showTag,showTimeSinceCommit:e?.showTimeSinceCommit,showStashCount:e?.showStashCount,showUpstream:e?.showUpstream,showRepoName:e?.showRepoName},t.workspace?.project_dir);return o?this.segmentRenderer.renderGit(o,n,e):null}renderSessionSegment(e,t,n){return t?this.segmentRenderer.renderSession(t,n,e):null}async renderTmuxSegment(e){if(!this.needsSegmentInfo("tmux"))return null;let t=await this.tmuxService.getSessionId();return this.segmentRenderer.renderTmux(t,e)}renderContextSegment(e,t,n){return this.needsSegmentInfo("context")?this.segmentRenderer.renderContext(t,n,e):null}renderMetricsSegment(e,t,n,s){return this.segmentRenderer.renderMetrics(t,s,n,e)}renderBlockSegment(e,t,n){return t?this.segmentRenderer.renderBlock(t,n,e):null}renderTodaySegment(e,t,n){if(!t)return null;let s=e?.type||"cost";return this.segmentRenderer.renderToday(t,n,s)}renderVersionSegment(e,t,n){return this.segmentRenderer.renderVersion(t,n,e)}initializeSymbols(){let e=this.config.display.style,t=this.config.display.charset||"unicode",n=e==="minimal",s=e==="capsule",o=t==="text"?Je:Ye;return {right:n?"":s?o.right_rounded:o.right,left:s?o.left_rounded:"",branch:o.branch,model:o.model,git_clean:o.git_clean,git_dirty:o.git_dirty,git_conflicts:o.git_conflicts,git_ahead:o.git_ahead,git_behind:o.git_behind,git_worktree:o.git_worktree,git_tag:o.git_tag,git_sha:o.git_sha,git_upstream:o.git_upstream,git_stash:o.git_stash,git_time:o.git_time,session_cost:o.session_cost,block_cost:o.block_cost,today_cost:o.today_cost,context_time:o.context_time,metrics_response:o.metrics_response,metrics_last_response:o.metrics_last_response,metrics_duration:o.metrics_duration,metrics_messages:o.metrics_messages,metrics_lines_added:o.metrics_lines_added,metrics_lines_removed:o.metrics_lines_removed,metrics_burn:o.metrics_burn,version:o.version,progress_filled:o.progress_filled,progress_empty:o.progress_empty,progress_left_bracket:o.progress_left_bracket,progress_right_bracket:o.progress_right_bracket,compact:o.compact}}getThemeColors(){let e=this.config.theme,t,n=this.config.display.colorCompatibility||"auto",s=n==="auto"?z():n;if(e==="custom"){if(t=this.config.colors?.custom,!t)throw new Error("Custom theme selected but no colors provided in configuration")}else t=q(e,s),t||(console.warn(`Built-in theme '${e}' not found, falling back to 'dark' theme`),t=q("dark",s));let o=q("dark",s),i=$=>{let R=t[$]||o[$]||{bg:"#4a5568",fg:"#cbd5e0"};return s==="none"?{bg:"",fg:""}:s==="ansi"?{bg:I(R.bg,true),fg:I(R.fg,false)}:s==="ansi256"?{bg:U(R.bg,true),fg:U(R.fg,false)}:{bg:L(R.bg,true),fg:L(R.fg,false)}},c=i("directory"),a=i("git"),g=i("model"),u=i("session"),m=i("block"),f=i("today"),d=i("tmux"),h=i("context"),p=i("metrics"),y=i("version"),b=($,ge)=>{let A=t[$]||o[$]||t[ge]||o[ge]||{bg:"#4a5568",fg:"#cbd5e0"};return s==="none"?{bg:"",fg:""}:s==="ansi"?{bg:I(A.bg,true),fg:I(A.fg,false)}:s==="ansi256"?{bg:U(A.bg,true),fg:U(A.fg,false)}:{bg:L(A.bg,true),fg:L(A.fg,false)}},E=b("contextLow","context"),C=b("contextMed","context"),B=b("contextHigh","context");return {reset:s==="none"?"":Ve,modeBg:c.bg,modeFg:c.fg,gitBg:a.bg,gitFg:a.fg,modelBg:g.bg,modelFg:g.fg,sessionBg:u.bg,sessionFg:u.fg,blockBg:m.bg,blockFg:m.fg,todayBg:f.bg,todayFg:f.fg,tmuxBg:d.bg,tmuxFg:d.fg,contextBg:h.bg,contextFg:h.fg,contextLowBg:E.bg,contextLowFg:E.fg,contextMedBg:C.bg,contextMedFg:C.fg,contextHighBg:B.bg,contextHighFg:B.fg,metricsBg:p.bg,metricsFg:p.fg,versionBg:y.bg,versionFg:y.fg}}getSegmentBgColor(e,t){switch(e){case "directory":return t.modeBg;case "git":return t.gitBg;case "model":return t.modelBg;case "session":return t.sessionBg;case "block":return t.blockBg;case "today":return t.todayBg;case "tmux":return t.tmuxBg;case "context":return t.contextBg;case "metrics":return t.metricsBg;case "version":return t.versionBg;default:return t.modeBg}}formatSegment(e,t,n,s,o){let i=this.config.display.style==="capsule",c=" ".repeat(this.config.display.padding??1);if(i){let f=this.config.display.colorCompatibility||"auto",h=(f==="auto"?z():f)==="ansi",p=J(e,h),y=`${p}${this.symbols.left}${o.reset}`,b=`${e}${t}${c}${n}${c}${o.reset}`,E=`${p}${this.symbols.right}${o.reset}`;return `${y}${b}${E}`}let a=`${e}${t}${c}${n}${c}`,g=this.config.display.colorCompatibility||"auto",m=(g==="auto"?z():g)==="ansi";if(s){let f=J(e,m);a+=`${o.reset}${s}${f}${this.symbols.right}`;}else a+=`${o.reset}${J(e,m)}${this.symbols.right}${o.reset}`;return a}};var Xe={theme:"dark",display:{style:"powerline",charset:"unicode",colorCompatibility:"auto",autoWrap:true,padding:1,lines:[{segments:{directory:{enabled:true,style:"basename"},git:{enabled:true,showSha:false,showWorkingTree:false,showOperation:false,showTag:false,showTimeSinceCommit:false,showStashCount:false,showUpstream:false,showRepoName:false},model:{enabled:true}}},{segments:{session:{enabled:true,type:"tokens",costSource:"calculated",showCompactCount:true}}},{segments:{context:{enabled:true,showPercentageOnly:false,style:"bar",barWidth:10,showBarPercentage:true,showBarTokens:true,thresholds:{low:50,high:80}}}}]},budget:{session:{warningThreshold:80},today:{warningThreshold:80,amount:50},block:{warningThreshold:80,amount:15}},modelContextLimits:{default:2e5,sonnet:2e5,opus:2e5}};function Ce(r){return ["light","dark","nord","tokyo-night","rose-pine","gruvbox","custom"].includes(r)}function _e(r){return r==="minimal"||r==="powerline"||r==="capsule"}function Ke(r){return r==="unicode"||r==="text"}function le(r,e){let t={...r};for(let n in e){let s=e[n];if(s!==void 0)if(typeof s=="object"&&s!==null&&!Array.isArray(s)){let o=t[n]||{};t[n]=le(o,s);}else t[n]=s;}return t}function Mt(r,e){return r?w.existsSync(r)?r:null:[...e?[_.join(e,".claude-powerline.json")]:[],_.join(process.cwd(),".claude-powerline.json"),_.join(ye.homedir(),".claude","claude-powerline.json"),_.join(ye.homedir(),".config","claude-powerline","config.json")].find(w.existsSync)||null}function Ft(r){try{let e=w.readFileSync(r,"utf-8");return JSON.parse(e)}catch(e){throw new Error(`Failed to load config file ${r}: ${e instanceof Error?e.message:String(e)}`)}}function Lt(){let r={},e={},t=process.env.CLAUDE_POWERLINE_THEME;t&&Ce(t)&&(r.theme=t);let n=process.env.CLAUDE_POWERLINE_STYLE;return n&&(_e(n)?e.style=n:(console.warn(`Invalid display style '${n}' from environment variable, falling back to 'minimal'`),e.style="minimal")),Object.keys(e).length>0&&(r.display=e),r}function Ut(){return process.env.CLAUDE_POWERLINE_CONFIG}function It(r){let e={},t={},n=r.find(i=>i.startsWith("--theme="))?.split("=")[1];n&&Ce(n)&&(e.theme=n);let s=r.find(i=>i.startsWith("--style="))?.split("=")[1];s&&(_e(s)?t.style=s:(console.warn(`Invalid display style '${s}' from CLI argument, falling back to 'minimal'`),t.style="minimal"));let o=r.find(i=>i.startsWith("--charset="))?.split("=")[1];return o&&(Ke(o)?t.charset=o:(console.warn(`Invalid charset '${o}' from CLI argument, falling back to 'unicode'`),t.charset="unicode")),Object.keys(t).length>0&&(e.display=t),e}function Ht(r=process.argv,e){let t=JSON.parse(JSON.stringify(Xe)),n=r.find(a=>a.startsWith("--config="))?.split("=")[1]||Ut(),s=n?.startsWith("~")?n.replace("~",ye.homedir()):n,o=Mt(s,e);if(o)try{let a=Ft(o);t=le(t,a);}catch(a){console.warn(`Warning: ${a instanceof Error?a.message:String(a)}`);}t.display?.style&&!_e(t.display.style)&&(console.warn(`Invalid display style '${t.display.style}' in config file, falling back to 'minimal'`),t.display.style="minimal"),t.display?.charset&&!Ke(t.display.charset)&&(console.warn(`Invalid charset '${t.display.charset}' in config file, falling back to 'unicode'`),t.display.charset="unicode"),t.theme&&!Ce(t.theme)&&(console.warn(`Invalid theme '${t.theme}' in config file, falling back to 'dark'`),t.theme="dark");let i=Lt();t=le(t,i);let c=It(r);return t=le(t,c),t}var Ze=Ht;function Qe(){console.log(`
claude-powerline - Beautiful powerline statusline for Claude Code

Usage: claude-powerline [options]

Standalone Commands:
  -h, --help               Show this help

Debugging:
  CLAUDE_POWERLINE_DEBUG=1 Enable debug logging for troubleshooting

Claude Code Options (for settings.json):
  --theme=THEME            Set theme: dark, light, nord, tokyo-night, rose-pine, custom
  --style=STYLE            Set separator style: minimal, powerline, capsule
  --charset=CHARSET        Set character set: unicode (default), text
  --config=PATH            Use custom config file path

See example config at: https://github.com/Owloops/claude-powerline/blob/main/.claude-powerline.json

`);}async function Nt(){try{(x.argv.includes("--help")||x.argv.includes("-h"))&&(Qe(),x.exit(0)),x.stdin.isTTY===!0&&(console.error(`Error: This tool requires input from Claude Code

claude-powerline is designed to be used as a Claude Code statusLine command.
It reads hook data from stdin and outputs formatted statusline.

Add to ~/.claude/settings.json:
{
  "statusLine": {
    "type": "command",
    "command": "claude-powerline --style=powerline"
  }
}

Run with --help for more options.

To test output manually:
echo '{"session_id":"test-session","workspace":{"project_dir":"/path/to/project"},"model":{"id":"claude-3-5-sonnet","display_name":"Claude"}}' | claude-powerline --style=powerline`),x.exit(1)),l(`Working directory: ${x.cwd()}`),l("Process args:",x.argv);let e=await json(x.stdin);l("Received hook data:",JSON.stringify(e,null,2)),e||(console.error("Error: No input data received from stdin"),Qe(),x.exit(1));let t=e.workspace?.project_dir,n=Ze(x.argv,t),o=await new ae(n).generateStatusline(e);console.log(o);}catch(r){let e=r instanceof Error?r.message:String(r);console.error("Error generating statusline:",e),x.exit(1);}}Nt();